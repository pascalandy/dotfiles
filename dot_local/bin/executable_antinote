#!/usr/bin/env bash
#
# ==============================================================================
# antinote - Query Antinote SQLite database
# ==============================================================================
# Query the Antinote app's SQLite database directly from the command line.
# Supports raw SQL queries and common shortcuts.
# ==============================================================================

readonly SCRIPT_VERSION="1.0.0"
readonly SCRIPT_AUTHOR="Pascal Andy"
readonly SCRIPT_DESCRIPTION="Query Antinote SQLite database."

readonly SCRIPT_NAME="${BASH_SOURCE[0]##*/}"

# ==============================================================================
# Configuration
# ==============================================================================

ANTINOTE_DB="$HOME/Library/Containers/com.chabomakers.Antinote/Data/Documents/notes.sqlite3"

# ==============================================================================
# Runtime options
# ==============================================================================

VERBOSE=0
DRY_RUN=0
NO_COLOR="${NO_COLOR:-}"

# ==============================================================================
# Strict mode
# ==============================================================================

set -euo pipefail

# ==============================================================================
# Logging
# ==============================================================================

fct_ansi() {
  local code="${1}"
  if [[ -t 2 && -z "${NO_COLOR}" ]]; then
    printf '\033[%sm' "${code}"
  fi
}

log_info() {
  local reset="" prefix=""
  if [[ -t 2 && -z "${NO_COLOR}" ]]; then
    prefix="$(fct_ansi '32')"
    reset="$(fct_ansi '0')"
  fi
  printf '%s%s%s\n' "${prefix}" "$*" "${reset}" >&2
}

log_error() {
  local reset="" prefix=""
  if [[ -t 2 && -z "${NO_COLOR}" ]]; then
    prefix="$(fct_ansi '31')"
    reset="$(fct_ansi '0')"
  fi
  printf '%s%s%s\n' "${prefix}" "$*" "${reset}" >&2
}

log_debug() {
  if [[ "${VERBOSE}" -eq 1 ]]; then
    local reset="" prefix=""
    if [[ -t 2 && -z "${NO_COLOR}" ]]; then
      prefix="$(fct_ansi '36')"
      reset="$(fct_ansi '0')"
    fi
    printf '%s[DEBUG] %s%s\n' "${prefix}" "$*" "${reset}" >&2
  fi
}

# ==============================================================================
# Usage
# ==============================================================================

usage() {
  cat << EOF
${SCRIPT_NAME} v${SCRIPT_VERSION}
${SCRIPT_DESCRIPTION}
Author: ${SCRIPT_AUTHOR}

Usage:
  ${SCRIPT_NAME} [options] <SQL query>
  ${SCRIPT_NAME} [options] --latest [N]
  ${SCRIPT_NAME} [options] --count
  ${SCRIPT_NAME} [options] --schema

Arguments:
  <SQL query>      Raw SQL query to execute

Options:
  -h, --help       Show this help and exit
  -V, --version    Show version and exit
  -v, --verbose    Enable debug logging
  -n, --dry-run    Show query without executing
      --no-color   Disable colored output

Shortcuts:
  --latest [N]     Show latest N notes (default: 1)
  --count          Count total notes
  --schema         Show database schema

Database location:
  ${ANTINOTE_DB}

Examples:
  ${SCRIPT_NAME} "SELECT content FROM notes ORDER BY lastModified DESC LIMIT 1"
  ${SCRIPT_NAME} --latest 5
  ${SCRIPT_NAME} --count
  ${SCRIPT_NAME} -n "SELECT * FROM notes"
EOF
}

# ==============================================================================
# Argument parsing
# ==============================================================================

SQL_QUERY=""
SHORTCUT=""
SHORTCUT_ARG=""

fct_parse_arguments() {
  while [[ $# -gt 0 ]]; do
    case "$1" in
      -h | --help)
        usage
        exit 0
        ;;
      -V | --version)
        printf '%s\n' "${SCRIPT_NAME} v${SCRIPT_VERSION}"
        exit 0
        ;;
      -v | --verbose)
        VERBOSE=1
        shift
        ;;
      -n | --dry-run)
        DRY_RUN=1
        shift
        ;;
      --no-color)
        NO_COLOR="1"
        shift
        ;;
      --latest)
        SHORTCUT="latest"
        shift
        # Check if next arg is a number
        if [[ $# -gt 0 && "$1" =~ ^[0-9]+$ ]]; then
          SHORTCUT_ARG="$1"
          shift
        else
          SHORTCUT_ARG="1"
        fi
        ;;
      --count)
        SHORTCUT="count"
        shift
        ;;
      --schema)
        SHORTCUT="schema"
        shift
        ;;
      -*)
        log_error "Unknown option: $1"
        usage
        exit 2
        ;;
      *)
        SQL_QUERY="$1"
        shift
        ;;
    esac
  done
}

# ==============================================================================
# Query execution
# ==============================================================================

fct_execute_query() {
  local query="${1}"

  if [[ "${DRY_RUN}" -eq 1 ]]; then
    log_info "[DRY-RUN] Would execute:"
    log_info "  Database: ${ANTINOTE_DB}"
    log_info "  Query: ${query}"
    return 0
  fi

  log_debug "Executing: ${query}"

  # Special handling for SELECT content queries
  if [[ "${query}" =~ SELECT.*content.*FROM.*notes ]]; then
    local result
    result=$(sqlite3 "${ANTINOTE_DB}" "${query}")

    if [[ -z "${result}" ]]; then
      local count
      count=$(sqlite3 "${ANTINOTE_DB}" "SELECT COUNT(*) FROM notes;")
      if [[ "${count}" -eq 0 ]]; then
        echo "No notes found in database."
      else
        echo "Note found but content is empty."
      fi
      return 0
    fi

    echo "${result}"
  else
    sqlite3 "${ANTINOTE_DB}" "${query}"
  fi
}

# ==============================================================================
# Main logic
# ==============================================================================

fct_execute() {
  # Check if database exists
  if [[ ! -f "${ANTINOTE_DB}" ]]; then
    log_error "Antinote database not found at: ${ANTINOTE_DB}"
    exit 1
  fi

  log_debug "Database: ${ANTINOTE_DB}"

  # Handle shortcuts
  if [[ -n "${SHORTCUT}" ]]; then
    case "${SHORTCUT}" in
      latest)
        SQL_QUERY="SELECT content FROM notes ORDER BY lastModified DESC LIMIT ${SHORTCUT_ARG}"
        ;;
      count)
        SQL_QUERY="SELECT COUNT(*) FROM notes"
        ;;
      schema)
        SQL_QUERY=".schema"
        ;;
    esac
  fi

  # Require a query
  if [[ -z "${SQL_QUERY}" ]]; then
    log_error "Missing required argument: <SQL query>"
    echo ""
    usage
    exit 2
  fi

  fct_execute_query "${SQL_QUERY}"
}

# ==============================================================================
# Main
# ==============================================================================

main() {
  fct_parse_arguments "$@"
  fct_execute
}

main "$@"
