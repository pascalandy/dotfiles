#!/usr/bin/env bash
#
# ==============================================================================
# spl3c - Tmux 3-pane split (1 top + 2 bottom) in chezmoi directory
# ==============================================================================
# Creates a tmux session with 3 panes: 1 large top, 2 smaller bottom.
# Pane 1: runs 'oc', Pane 2: runs 'ls', Pane 3: runs 'oc'
# ==============================================================================

readonly SCRIPT_VERSION="1.0.0"
readonly SCRIPT_AUTHOR="Pascal Andy"
readonly SCRIPT_DESCRIPTION="Tmux 3-pane split (1 top + 2 bottom) in chezmoi directory."
: "${SCRIPT_AUTHOR}" "${SCRIPT_DESCRIPTION}"

readonly SCRIPT_NAME="${BASH_SOURCE[0]##*/}"

# ==============================================================================
# Configuration
# ==============================================================================

DEFAULT_DIR="$HOME/.local/share/chezmoi"

# ==============================================================================
# Runtime options
# ==============================================================================

VERBOSE=0
DRY_RUN=0
WORK_DIR=""

# ==============================================================================
# Logging
# ==============================================================================

log_info() { printf '%s\n' "$*" >&2; }
log_debug() { [[ "${VERBOSE}" -eq 1 ]] && printf '[DEBUG] %s\n' "$*" >&2; }
log_error() { printf 'ERROR: %s\n' "$*" >&2; }

# ==============================================================================
# Usage
# ==============================================================================

usage() {
	cat <<'EOF'
spl3c v1.0.0
Tmux 3-pane split (1 top + 2 bottom) in chezmoi directory.

LAYOUT:
  ┌─────────────────────────────────────┐
  │           Pane 1 (oc)               │
  │             67%                     │
  ├───────────────────────┬─────────────┤
  │    Pane 2 (ls)        │  Pane 3 (oc)│
  │       67%             │     33%     │
  └───────────────────────┴─────────────┘

Usage:
  spl3c [options] [directory]

Options:
  -h, --help       Show this help and exit
  -V, --version    Show version and exit
  -v, --verbose    Enable debug logging
  -n, --dry-run    Show what would be done without executing

Examples:
  spl3c                   # Use default chezmoi directory
  spl3c ~/dotfiles        # Use custom directory
  spl3c -n                # Dry-run
EOF
}

# ==============================================================================
# Argument parsing
# ==============================================================================

fct_parse_arguments() {
	while [[ $# -gt 0 ]]; do
		case "$1" in
		-h | --help)
			usage
			exit 0
			;;
		-V | --version)
			printf '%s\n' "${SCRIPT_NAME} v${SCRIPT_VERSION}"
			exit 0
			;;
		-v | --verbose)
			VERBOSE=1
			shift
			;;
		-n | --dry-run)
			DRY_RUN=1
			shift
			;;
		-*)
			log_error "Unknown option: $1"
			usage
			exit 2
			;;
		*)
			WORK_DIR="$1"
			shift
			;;
		esac
	done

	WORK_DIR="${WORK_DIR:-$DEFAULT_DIR}"
}

# ==============================================================================
# Helper: Wait for shell prompt
# ==============================================================================

fct_wait_for_prompt() {
	local target="$1" timeout="${2:-5}"
	local i=0

	while ((i < timeout * 10)); do
		if tmux capture-pane -t "$target" -p 2>/dev/null | grep -qE '^[>$❯]\s*$'; then
			return 0
		fi
		sleep 0.1
		i=$((i + 1))
	done
	return 1
}

# ==============================================================================
# Main logic
# ==============================================================================

fct_execute() {
	if ! command -v tmux &>/dev/null; then
		log_error "tmux is not installed"
		exit 1
	fi

	if [[ ! -d "${WORK_DIR}" ]]; then
		log_error "Directory does not exist: ${WORK_DIR}"
		exit 1
	fi

	local session_name
	session_name="dev-$(uuidgen | cut -c1-6)"

	log_debug "Directory: ${WORK_DIR}"
	log_debug "Session: ${session_name}"

	if [[ "${DRY_RUN}" -eq 1 ]]; then
		log_info "[DRY-RUN] Would execute:"
		log_info "  tmux new-session -d -s ${session_name} -c ${WORK_DIR}"
		log_info "  tmux split-window -v -p 33 (bottom 33%)"
		log_info "  tmux split-window -h -p 33 (bottom-right 33%)"
		log_info "  Pane 1: oc"
		log_info "  Pane 2: ls"
		log_info "  Pane 3: oc"
		log_info "  tmux attach -t ${session_name}"
		return 0
	fi

	tmux new-session -d -s "$session_name" -c "$WORK_DIR"
	tmux split-window -v -p 33 -t "$session_name" -c "$WORK_DIR"
	tmux split-window -h -p 33 -t "$session_name.2" -c "$WORK_DIR"
	tmux select-pane -t "$session_name.1"

	fct_wait_for_prompt "$session_name.1"
	tmux send-keys -t "$session_name.1" 'oc' Enter
	fct_wait_for_prompt "$session_name.2"
	tmux send-keys -t "$session_name.2" 'ls' Enter
	fct_wait_for_prompt "$session_name.3"
	tmux send-keys -t "$session_name.3" 'oc' Enter

	tmux attach -t "$session_name"
}

# ==============================================================================
# Main
# ==============================================================================

main() {
	fct_parse_arguments "$@"
	fct_execute
}

main "$@"
